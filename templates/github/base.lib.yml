#@ load("ytt.lib.yml", "ytt_processor")

#@ def job(environment_name, repo, processor):
runs-on: ubuntu-latest
steps:
  - uses: actions/checkout@v2
    with:
      ref: #@ repo["branch"]
      fetch-depth: 0
  - id: prepare-cepler
    uses: bodymindarts/cepler-action@main
    with:
      environment: #@ environment_name
      prepare: true
  - if: ${{ steps.prepare-cepler.outputs.needs_deploying == 'true' }}
    uses: k14s/setup-k14s-action@v1
    with:
      only: ytt, kapp
#@ if/end processor["type"] == "ytt":
  - #@ ytt_processor(processor)
#@ if/end processor["debug"]:
  - if: ${{ steps.prepare-cepler.outputs.needs_deploying == 'true' }}
    name: Debug processor
    run: cat rendered.yml
#@ end

#@ def jobs(environments, repo, processor):
#@   jobs = {}
#@   for name in environments:
#@     jobs.update([("deploy-" + name, job(name, repo, processor))])
#@   end
#@ return jobs
#@ end

#@ def github(ci, cepler):
name: cepler-deploy
"on": [push]
jobs: #@ jobs(cepler["environments"], ci["driver"]["repo"], ci["processor"])

#@ end
