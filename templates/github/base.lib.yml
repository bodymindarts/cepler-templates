#@ load("ytt.lib.yml", "ytt_processor")
#@ load("@ytt:json", "json")

#@ def job(environment_name, config_path, repo, processor, secrets):
runs-on: ubuntu-latest
steps:
  - uses: actions/checkout@v2
    with:
      ref: #@ repo["branch"]
      fetch-depth: 0
  - id: prepare-cepler
    uses: bodymindarts/cepler-action@main
    with:
      config_path: #@ config_path
      environment: #@ environment_name
      prepare: true
  - if: ${{ steps.prepare-cepler.outputs.needs_deploying == 'true' }}
    uses: k14s/setup-k14s-action@v1
    with:
      only: ytt, kapp
#@ if secrets:
  - if: ${{ steps.prepare-cepler.outputs.needs_deploying == 'true' }}
    name: render-secrets
    env:
      SECRETS: #@ json.encode(secrets)
    run: |
      cat <<EOF > secrets.yml
      #@data/values
      #@ load("@ytt:overlay", "overlay")
      #@overlay/match-child-defaults missing_ok=True
      ---
      ${SECRETS}
      EOF
#@ end
#@ if/end processor["type"] == "ytt":
  - #@ ytt_processor(processor, secrets)
#@ if/end processor["debug"]:
  - if: ${{ steps.prepare-cepler.outputs.needs_deploying == 'true' }}
    run: cat rendered.yml
#@ end

#@ def jobs(environments, config_path, repo, processor, secrets):
#@   jobs = {}
#@   for name in environments:
#@     jobs.update([("deploy-" + name, job(name, config_path, repo, processor, secrets))])
#@   end
#@   return jobs
#@ end

#@ def github(ci, cepler):
name: cepler-deploy
"on": [push]
jobs: #@ jobs(cepler["environments"], ci["cepler"]["config"], ci["driver"]["repo"], ci["processor"], ci["driver"]["secrets"])

#@ end
